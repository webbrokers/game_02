<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>War Tanks — Выбор</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="menu.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js" defer></script>
  </head>
  <body class="menu-screen">
    <div class="menu-overlay">
      <header class="menu-header">
        <span class="menu-brand">WAR TANKS II</span>
      </header>
      <main class="menu-panel select-panel" role="main">
        <h1 class="panel-title" id="mode-title">Выбор миссии</h1>
        
        <!-- Room Info -->
        <div id="room-info" style="display: none; text-align: center; margin-bottom: 2rem;">
            <h2 class="section-title" style="margin-bottom: 1rem;">Комната: <span id="room-name-display" style="color: #4ade80;">...</span></h2>
            <div id="countdown-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; flex-direction: column;">
                <h1 style="font-size: 4rem; color: #fff; margin-bottom: 2rem;">ИГРА НАЧНЕТСЯ ЧЕРЕЗ</h1>
                <div id="countdown-timer" style="font-size: 8rem; color: #4ade80; text-shadow: 0 0 20px #4ade80;">5</div>
            </div>
            
            <div class="players-list" style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 4px; border: 1px solid #334155;">
                <div style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 0.5rem;">ИГРОКИ В ЛОББИ:</div>
                <div id="players-container" style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                    <!-- Players will be added here -->
                    <div style="color: #64748b;">Ожидание игроков...</div>
                </div>
            </div>
        </div>
        <button
          id="copy-link"
          class="retro-button ghost"
          style="margin-bottom: 2rem; display: none"
        >
          Скопировать ссылку
        </button>
        <form
          class="selection-form"
          id="play-form"
          action="play.html"
          method="get"
        >
          <input type="hidden" name="room" id="room-id" />
          <input type="hidden" name="host" id="host-input" />
          <section class="selection-group" aria-labelledby="tank-heading">
            <h2 class="section-title" id="tank-heading">Выбор танка</h2>
            <div class="card-grid">
              <label class="select-card">
                <input type="radio" name="tank" value="tiger" checked />
                <span class="card-title">Tiger MK-II</span>
                <span class="card-meta">Броня 5 ▪️ Скорость 3</span>
                <span class="card-meta">Урон 4 ▪️ Дальность 2</span>
              </label>
              <label class="select-card">
                <input type="radio" name="tank" value="phantom" />
                <span class="card-title">Phantom X</span>
                <span class="card-meta">Броня 3 ▪️ Скорость 5</span>
                <span class="card-meta">Урон 3 ▪️ Дальность 4</span>
              </label>
              <label class="select-card">
                <input type="radio" name="tank" value="crusher" />
                <span class="card-title">Crusher 88</span>
                <span class="card-meta">Броня 6 ▪️ Скорость 2</span>
                <span class="card-meta">Урон 5 ▪️ Дальность 3</span>
              </label>
            </div>
          </section>
          <section class="selection-group" aria-labelledby="map-heading">
            <h2 class="section-title" id="map-heading">Карта</h2>
            <div class="card-grid">
              <label class="select-card">
                <input type="radio" name="map" value="desert" checked />
                <span class="card-title">Desert Strike</span>
                <span class="card-meta"
                  >Открытая пустыня, минимальное укрытие</span
                >
              </label>
              <label class="select-card">
                <input type="radio" name="map" value="frozen" />
                <span class="card-title">Frozen Front</span>
                <span class="card-meta"
                  >Ледяные переправы, среднее укрытие</span
                >
              </label>
              <label class="select-card">
                <input type="radio" name="map" value="urban" />
                <span class="card-title">Urban Siege</span>
                <span class="card-meta">Городские руины, плотное укрытие</span>
              </label>
            </div>
          </section>
          <div class="button-row">
            <button
              class="retro-button ghost"
              type="submit"
              name="action"
              value="back"
              formaction="menu.html"
              formmethod="get"
              formnovalidate
            >
              Назад
            </button>
            <button
              class="retro-button"
              type="submit"
              name="action"
              value="start"
              formaction="play.html"
              formmethod="get"
            >
              В бой!
            </button>
          </div>
        </form>
      </main>
    </div>
    <script type="module">
      import { SUPABASE_URL, SUPABASE_KEY } from './js/supabase-config.js';

      const { createClient } = supabase;
      const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

      const params = new URLSearchParams(window.location.search);
      const roomId = params.get("room");
      const isHost = params.get("host") === "1";
      const copyBtn = document.getElementById("copy-link");
      const roomInfo = document.getElementById("room-info");
      const roomNameDisplay = document.getElementById("room-name-display");
      const playersContainer = document.getElementById("players-container");
      const countdownOverlay = document.getElementById("countdown-overlay");
      const countdownTimer = document.getElementById("countdown-timer");
      
      let isNavigatingAway = false;
      let channel = null;
      let currentPlayerName = localStorage.getItem('wt2:player-name') || 'Commander';

      async function initLobby() {
        if (!roomId) return;

        document.getElementById("room-id").value = roomId;
        document.getElementById("host-input").value = isHost ? "1" : "0";
        document.getElementById("mode-title").textContent = "MULTIPLAYER: ВХОД";
        
        // Show lobby UI
        roomInfo.style.display = "block";
        copyBtn.style.display = "block";

        // Setup copy button
        copyBtn.onclick = (e) => {
          e.preventDefault();
          
          // Генерируем ссылку БЕЗ параметра host
          const url = new URL(window.location.href);
          url.searchParams.delete('host');
          
          navigator.clipboard.writeText(url.toString()).then(() => {
            const originalText = copyBtn.textContent;
            copyBtn.textContent = "СКОПИРОВАНО!";
            copyBtn.style.color = "#8dffd6";
            setTimeout(() => {
              copyBtn.textContent = originalText;
              copyBtn.style.color = "";
            }, 2000);
          }).catch(err => {
            console.error("Ошибка копирования:", err);
            alert("Не удалось скопировать ссылку");
          });
        };

        // Fetch room name
        const { data: room, error } = await supabaseClient
            .from('rooms')
            .select('name')
            .eq('id', roomId)
            .single();

        if (room) {
            roomNameDisplay.textContent = room.name;
        }

        // Connect to Realtime channel
        channel = supabaseClient.channel(`room_${roomId}`, {
            config: {
                presence: {
                    key: currentPlayerName,
                },
            },
        });

        channel
            .on('presence', { event: 'sync' }, () => {
                const state = channel.presenceState();
                updatePlayersList(state);
            })
            .subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                    await channel.track({
                        name: currentPlayerName,
                        online_at: new Date().toISOString(),
                    });
                }
            });
      }

      function updatePlayersList(state) {
        const players = [];
        for (const key in state) {
            // state[key] is an array of presence objects for that key
            // We just take the first one since key is nickname
            if (state[key] && state[key].length > 0) {
                players.push(state[key][0]);
            }
        }

        playersContainer.innerHTML = '';
        
        if (players.length === 0) {
            playersContainer.innerHTML = '<div style="color: #64748b;">Никого нет...</div>';
            return;
        }

        // Sort players to keep order consistent
        players.sort((a, b) => a.online_at.localeCompare(b.online_at));

        players.forEach(p => {
            const el = document.createElement('div');
            el.style.cssText = 'display: flex; align-items: center; gap: 0.5rem;';
            const isMe = p.name === currentPlayerName;
            el.innerHTML = `
                <span style="color: ${isMe ? '#fbbf24' : '#fff'}; font-weight: bold;">${p.name}</span>
                <span style="color: #4ade80; font-size: 0.8rem;">● ONLINE</span>
            `;
            playersContainer.appendChild(el);
        });

        // Check for auto-start
        if (players.length >= 2) {
            startCountdown();
        }
      }

      let countdownInterval = null;
      function startCountdown() {
          if (countdownInterval) return; // Already started
          
          countdownOverlay.style.display = 'flex';
          let timeLeft = 5;
          countdownTimer.textContent = timeLeft;

          // Disable form interactions
          const form = document.getElementById('play-form');
          const elements = form.elements;
          for (let i = 0; i < elements.length; i++) {
            // Не отключаем скрытые поля, иначе они не отправятся!
            if (elements[i].type !== 'hidden') {
                elements[i].disabled = true;
            }
          }

          countdownInterval = setInterval(() => {
              timeLeft--;
              countdownTimer.textContent = timeLeft;
              
              if (timeLeft <= 0) {
                  clearInterval(countdownInterval);
                  // Auto submit form
                  isNavigatingAway = true;
                  form.submit(); // Using get method, will navigate to play.html
              }
          }, 1000);
      }

      // Функция закрытия комнаты (beacon)
      function closeRoomBeacon(id) {
        if (!id) return;
        const body = JSON.stringify({ status: 'closed' });
        const url = `${SUPABASE_URL}/rest/v1/rooms?id=eq.${id}`;
        fetch(url, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: body,
          keepalive: true
        });
      }

      // Обработка перехода
      const playForm = document.getElementById('play-form');
      playForm.onsubmit = (e) => {
        // Если нажата кнопка "В бой!", то мы продолжаем игру в этой комнате
        if (e.submitter && e.submitter.value === 'start') {
          isNavigatingAway = true;
        } else if (countdownInterval) {
           // If auto-submitting
           isNavigatingAway = true;
        } else {
          // Если "Назад", то закрываем комнату (isNavigatingAway остается false, сработает beforeunload)
          if (isHost && roomId) {
            closeRoomBeacon(roomId);
          }
        }
      };

      // Обработка выхода
      window.addEventListener('beforeunload', () => {
        if (isHost && roomId && !isNavigatingAway) {
          closeRoomBeacon(roomId);
        }
        if (channel) {
            channel.unsubscribe();
        }
      });

      // Start
      initLobby();
    </script>
  </body>
</html>
